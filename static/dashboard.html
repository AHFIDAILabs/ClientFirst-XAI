<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Insights Dashboard | Gamsuwa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Optional: Style for the new labels to ensure they look good */
        .form-group-grid label sub {
            font-weight: 400;
            color: #555;
            display: block;
            font-size: 0.75em;
            margin-top: 2px;
        }
        .dark-mode .form-group-grid label sub {
            color: #bbb;
        }
    </style>
</head>
<body>
    <div class="container dashboard-page">
        <header>
            <div class="header-top">
                <h1>Client Insights Dashboard</h1>
                <div class="dark-mode-toggle">
                    <input type="checkbox" id="darkModeToggle" class="toggle-checkbox">
                    <label for="darkModeToggle" class="toggle-label">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                        <span class="ball"></span>
                    </label>
                </div>
            </div>
            <nav class="main-nav">
                <a href="/"><i class="fas fa-home"></i><span>Home</span></a>
                <a href="/dashboard"><i class="fas fa-chart-line"></i><span>Prediction</span></a>
                <a href="/contact"><i class="fas fa-envelope"></i><span>Contact</span></a>
                <a href="/faq"><i class="fas fa-question-circle"></i><span>FAQ</span></a>
                <div class="search-bar">
                    <input type="text" placeholder="Search...">
                    <button><i class="fas fa-search"></i></button>
                </div>
            </nav>
        </header>

        <main>
            <section class="widgets-grid">
                <div class="widget metrics-widget">
                    <h3><i class="fas fa-tachometer-alt"></i> Key Metrics</h3>
                    <div class="metric-item">
                        <span class="metric-value">12,500+</span>
                        <span class="metric-label">Clients Served</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">92%</span>
                        <span class="metric-label">Avg. Satisfaction</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">45</span>
                        <span class="metric-label">Facilities Covered</span>
                    </div>
                </div>

                <div class="widget testimonials-widget">
                    <h3><i class="fas fa-comments"></i> Testimonials</h3>
                    <div class="testimonial-item">
                        <blockquote>"This tool provides incredible insights that have helped us improve our care delivery significantly."</blockquote>
                        <cite>- Facility Manager, Kwara State</cite>
                    </div>
                    <div class="testimonial-item">
                        <blockquote>"Understanding the drivers of satisfaction is a game-changer for patient retention."</blockquote>
                        <cite>- Healthcare Provider</cite>
                    </div>
                </div>

                <div class="widget activity-widget">
                    <h3><i class="fas fa-history"></i> Recent Activity</h3>
                    <ul>
                        <li><i class="fas fa-check-circle success"></i> Prediction for Client #4821 - High Satisfaction</li>
                        <li><i class="fas fa-exclamation-triangle warning"></i> Prediction for Client #4820 - Low Satisfaction</li>
                        <li><i class="fas fa-check-circle success"></i> Prediction for Client #4819 - High Satisfaction</li>
                    </ul>
                </div>
            </section>

            <hr class="divider">

            <section class="input-form-section" id="inputFormSection">
                <h2>üìù Client & Provider Interaction Details</h2>
                <form id="predictionForm">
                    <div class="form-group-grid">
                        <fieldset>
                            <legend>Patient Demographics</legend>
                            <div>
                                <label for="age">Age:</label>
                                <input type="number" id="age" name="Age" min="18" max="100" value="35" required>
                            </div>
                            <div>
                                <label for="employment">Employment Status:</label>
                                <select id="employment" name="Employment_Grouped" required></select>
                            </div>
                            <div>
                                <label for="education">Education Level:</label>
                                <select id="education" name="Education_Grouped" required></select>
                            </div>
                            <div>
                                <label for="state">State (Optional):</label>
                                <select id="state" name="State"></select>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Care History (in Years)</legend>
                            <div>
                                <label for="hivDuration">Duration of HIV Diagnosis:</label>
                                <input type="number" id="hivDuration" name="HIV_Duration_Years" min="0.0" step="0.5" value="5.0" required>
                            </div>
                            <div>
                                <label for="careDuration">Duration at This Facility:</label>
                                <input type="number" id="careDuration" name="Care_Duration_Years" min="0.0" step="0.5" value="2.0" required>
                            </div>
                            <div>
                                <label for="facilityCareDuration">Total Duration in Care:</label>
                                <input type="number" id="facilityCareDuration" name="Facility_Care_Dur_Years" min="0.0" step="0.5" value="5.0" required>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Patient Engagement & Experience</legend>
                            <div>
                                <label for="empathyScore">Empathy Score <sub>(['Showed_Personal_Concern', 'Greet_Comfort', 'Respond_Q_Concerns', 'Time_Spent_Adequate']):</sub></label>
                                <input type="number" id="empathyScore" name="Empathy_Score" min="1" max="5" step="1" value="4" required>
                            </div>
                            <div>
                                <label for="listeningScore">Listening Score <sub>(['Encourage_Thoughts', 'Listen_Careful', 'Understood_You']):</sub></label>
                                <input type="number" id="listeningScore" name="Listening_Score" min="1" max="5" step="1" value="4" required>
                            </div>
                            <div>
                                <label for="decisionScore">Decision Share Score <sub>(['Involved_In_Decisions', 'Checked_Understanding', 'Encourage_Questions']):</sub></label>
                                <input type="number" id="decisionScore" name="Decision_Share_Score" min="1" max="5" step="1" value="3" required>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Communication & Information</legend>
                            <div>
                                <label for="examExplained">Exams/procedures explained clearly:</label>
                                <select id="examExplained" name="Exam_Explained" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                            <div>
                                <label for="discussNextSteps">Discussed next steps in care:</label>
                                <select id="discussNextSteps" name="Discuss_NextSteps" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                        </fieldset>
                    </div>
                    <button type="submit">üöÄ Predict & Explain Satisfaction</button>
                </form>
            </section>
            
            <section id="results-section" class="results-section" style="display: none;">
                <h2>Prediction Results</h2>
                <div class="prediction-metrics">
                    <div class="metric-card">
                        <h3>Predicted Satisfaction Level</h3>
                        <p id="predictedSatisfaction" class="big-text"></p>
                    </div>
                    <div class="metric-card">
                        <h3>Prediction Confidence</h3>
                        <p id="predictionConfidence" class="big-text"></p>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'aiSummary')">‚ú® AI Summary</button>
                    <button class="tab-button" onclick="openTab(event, 'detailedAnalysis')">üß† Detailed Analysis</button>
                    <button class="tab-button" onclick="openTab(event, 'modelInput')">‚öôÔ∏è Model Input</button>
                </div>
                <div id="aiSummary" class="tab-content active">
                    <h3>üìù Generative AI Explanation</h3>
                    <div id="genaiExplanation" class="explanation-content"></div>
                </div>
                <div id="detailedAnalysis" class="tab-content">
                    <h3>üéØ Top Contributing Factors (SHAP)</h3>
                    <ul id="topFeaturesList" class="features-list"></ul>
                    <h3>üìà SHAP Waterfall Plot</h3>
                    <div id="shapWaterfallPlot" class="chart-container">
                        <p>A SHAP waterfall plot would appear here. The bar chart below shows the impact of each feature.</p>
                        <canvas id="shapBarChart"></canvas>
                    </div>
                </div>
                <div id="modelInput" class="tab-content">
                    <h3>üî¢ Features Sent to Model</h3>
                    <pre><code id="modelInputJson"></code></pre>
                </div>
            </section>
        </main>
    </div>

    <div class="social-media-icons">
        <a href="https://ahfid.org/contact-us/#" target="_blank" title="Website"><i class="fas fa-globe"></i></a>
        <a href="https://wa.me/2348034011043" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://x.com/Ahfidorg" target="_blank" title="X (Twitter)"><i class="fab fa-xing"></i></a>
        <a href="https://instagram.com/Ahfidorg" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://youtube.com/@AfricaHubforInnovation" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
        <a href="https://web.facebook.com/profile.php?id=61578622870670" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
    </div>

    <img src="/static/images/ahfid.png" alt="AHFID Logo" class="ahfid-logo-bottom">

    <footer>
        <p>&copy; 2025 Gamsuwa - Africa Hub for Innovation and Development. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Dark Mode Toggle Logic ---
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;

            if (localStorage.getItem('darkMode') === 'enabled') {
                body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
                if (window.lastShapData) {
                    renderShapBarChart(window.lastShapData.featureNames, window.lastShapData.shapValues);
                }
            });

            // --- Original JS for categories and form submission ---
            async function loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const categories = await response.json();

                    const employmentSelect = document.getElementById('employment');
                    employmentSelect.innerHTML = '';
                    categories.Employment_Grouped.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        employmentSelect.appendChild(option);
                    });

                    const educationSelect = document.getElementById('education');
                    educationSelect.innerHTML = '';
                    categories.Education_Grouped.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        educationSelect.appendChild(option);
                    });

                    const stateSelect = document.getElementById('state');
                    if (categories.State && categories.State.length > 0) {
                        stateSelect.innerHTML = '<option value="">Select State (Optional)</option>';
                        categories.State.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            stateSelect.appendChild(option);
                        });
                    } else {
                        stateSelect.parentElement.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading categories:', error);
                    alert('Failed to load category options. Please try again later.');
                }
            }

            loadCategories();

            const form = document.getElementById('predictionForm');
            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                if (!data['State']) delete data['State'];

                const submitButton = document.querySelector('button[type="submit"]');
                submitButton.textContent = 'Analyzing...';
                submitButton.disabled = true;
                document.getElementById('results-section').style.display = 'none';

                try {
                    const response = await fetch('/api/predict_explain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    document.getElementById('predictedSatisfaction').textContent = result.prediction;
                    document.getElementById('predictionConfidence').textContent = result.confidence;
                    document.getElementById('genaiExplanation').innerHTML = marked.parse(result.genai_explanation);

                    const topFeaturesList = document.getElementById('topFeaturesList');
                    topFeaturesList.innerHTML = '';
                    for (const feature in result.top_features) {
                        const value = result.top_features[feature];
                        const impact = value > 0 ? 'Positive' : 'Negative';
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${feature.replace(/_/g, ' ')}</strong>: SHAP Value = <code>${value.toFixed(3)}</code> (<span class="${impact.toLowerCase()}">${impact}</span> impact)`;
                        topFeaturesList.appendChild(li);
                    }

                    document.getElementById('modelInputJson').textContent = JSON.stringify(result.feature_values.reduce((obj, val, i) => {
                        obj[result.feature_names[i]] = val;
                        return obj;
                    }, {}), null, 2);

                    window.lastShapData = { featureNames: result.feature_names, shapValues: result.shap_values };
                    renderShapBarChart(result.feature_names, result.shap_values);
                    document.getElementById('results-section').style.display = 'block';
                    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error('Error during prediction:', error);
                    alert(`Prediction failed: ${error.message}`);
                } finally {
                    submitButton.textContent = 'üöÄ Predict & Explain Satisfaction';
                    submitButton.disabled = false;
                }
            });

            window.openTab = function (evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tab-button");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }

            document.querySelector('.tab-button').click();

            function renderShapBarChart(featureNames, shapValues) {
                const ctx = document.getElementById('shapBarChart').getContext('2d');
                const isDarkMode = document.body.classList.contains('dark-mode');

                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#E0E0E0' : '#333';
                const positiveColor = '#4CAF50';
                const negativeColor = '#F44336';
                const positiveBorder = '#388E3C';
                const negativeBorder = '#D32F2F';

                const combined = featureNames.map((name, i) => ({ name, value: shapValues[i] }));
                combined.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));

                const sortedFeatureNames = combined.map(item => item.name.replace(/_/g, ' '));
                const sortedShapValues = combined.map(item => item.value);

                if (window.shapChart) window.shapChart.destroy();

                window.shapChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedFeatureNames,
                        datasets: [{
                            label: 'SHAP Value',
                            data: sortedShapValues,
                            backgroundColor: sortedShapValues.map(value => value > 0 ? positiveColor : negativeColor),
                            borderColor: sortedShapValues.map(value => value > 0 ? positiveBorder : negativeBorder),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: gridColor },
                                ticks: { color: textColor },
                                title: { display: true, text: 'SHAP Value (Impact on Prediction)', color: textColor }
                            },
                            y: {
                                grid: { color: gridColor },
                                ticks: { color: textColor },
                                title: { display: true, text: 'Feature', color: textColor }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { 
                                display: true, 
                                text: 'Feature Importance (SHAP Values)',
                                color: textColor,
                                font: { size: 16 }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>




<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Insights Dashboard | Gamsuwa</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container dashboard-page">
        <header>
            <div class="header-top">
                <h1>Client Insights Dashboard</h1>
                <div class="dark-mode-toggle">
                    <input type="checkbox" id="darkModeToggle" class="toggle-checkbox">
                    <label for="darkModeToggle" class="toggle-label">
                        <i class="fas fa-moon"></i>
                        <i class="fas fa-sun"></i>
                        <span class="ball"></span>
                    </label>
                </div>
            </div>
            <nav class="main-nav">
                <a href="index.html"><i class="fas fa-home"></i><span>Home</span></a>
                <a href="dashboard.html"><i class="fas fa-chart-line"></i><span>Prediction</span></a>
                <a href="contact.html"><i class="fas fa-envelope"></i><span>Contact</span></a>
                <a href="faq.html"><i class="fas fa-question-circle"></i><span>FAQ</span></a>
                <div class="search-bar">
                    <input type="text" placeholder="Search...">
                    <button><i class="fas fa-search"></i></button>
                </div>
            </nav>
        </header>

        <main>
            <section class="widgets-grid">
                <div class="widget metrics-widget">
                    <h3><i class="fas fa-tachometer-alt"></i> Key Metrics</h3>
                    <div class="metric-item">
                        <span class="metric-value">12,500+</span>
                        <span class="metric-label">Clients Served</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">92%</span>
                        <span class="metric-label">Avg. Satisfaction</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-value">45</span>
                        <span class="metric-label">Facilities Covered</span>
                    </div>
                </div>

                <div class="widget testimonials-widget">
                    <h3><i class="fas fa-comments"></i> Testimonials</h3>
                    <div class="testimonial-item">
                        <blockquote>"This tool provides incredible insights that have helped us improve our care delivery significantly."</blockquote>
                        <cite>- Facility Manager, Kwara State</cite>
                    </div>
                    <div class="testimonial-item">
                        <blockquote>"Understanding the drivers of satisfaction is a game-changer for patient retention."</blockquote>
                        <cite>- Healthcare Provider</cite>
                    </div>
                </div>

                <div class="widget activity-widget">
                    <h3><i class="fas fa-history"></i> Recent Activity</h3>
                    <ul>
                        <li><i class="fas fa-check-circle success"></i> Prediction for Client #4821 - High Satisfaction</li>
                        <li><i class="fas fa-exclamation-triangle warning"></i> Prediction for Client #4820 - Low Satisfaction</li>
                        <li><i class="fas fa-check-circle success"></i> Prediction for Client #4819 - High Satisfaction</li>
                    </ul>
                </div>
            </section>

            <hr class="divider">

            <section class="input-form-section" id="inputFormSection">
                <h2>üìù Client & Provider Interaction Details</h2>
                <form id="predictionForm">
                    <div class="form-group-grid">
                        <fieldset>
                            <legend>Patient Demographics</legend>
                            <div>
                                <label for="age">Age:</label>
                                <input type="number" id="age" name="Age" min="18" max="100" value="35" required>
                            </div>
                            <div>
                                <label for="employment">Employment Status:</label>
                                <select id="employment" name="Employment_Grouped" required></select>
                            </div>
                            <div>
                                <label for="education">Education Level:</label>
                                <select id="education" name="Education_Grouped" required></select>
                            </div>
                            <div>
                                <label for="state">State (Optional):</label>
                                <select id="state" name="State"></select>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Care History (in Years)</legend>
                            <div>
                                <label for="hivDuration">Duration of HIV Diagnosis:</label>
                                <input type="number" id="hivDuration" name="HIV_Duration_Years" min="0.0" step="0.5" value="5.0" required>
                            </div>
                            <div>
                                <label for="careDuration">Duration at This Facility:</label>
                                <input type="number" id="careDuration" name="Care_Duration_Years" min="0.0" step="0.5" value="2.0" required>
                            </div>
                            <div>
                                <label for="facilityCareDuration">Total Duration in Care:</label>
                                <input type="number" id="facilityCareDuration" name="Facility_Care_Dur_Years" min="0.0" step="0.5" value="5.0" required>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Patient Engagement & Experience</legend>
                            <div>
                                <label for="empathyLikert">Provider Empathy:</label>
                                <select id="empathyLikert" name="Empathy_Score" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                            <div>
                                <label for="listeningLikert">Active Listening:</label>
                                <select id="listeningLikert" name="Listening_Score" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                            <div>
                                <label for="decisionLikert">Decision Involvement:</label>
                                <select id="decisionLikert" name="Decision_Share_Score" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Communication & Information</legend>
                            <div>
                                <label for="examExplained">Exams/procedures explained clearly:</label>
                                <select id="examExplained" name="Exam_Explained" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                            <div>
                                <label for="discussNextSteps">Discussed next steps in care:</label>
                                <select id="discussNextSteps" name="Discuss_NextSteps" required>
                                    <option value="Strongly Disagree">Strongly Disagree</option>
                                    <option value="Disagree">Disagree</option>
                                    <option value="Neither Agree Or Disagree">Neither Agree Or Disagree</option>
                                    <option value="Agree" selected>Agree</option>
                                    <option value="Strongly Agree">Strongly Agree</option>
                                </select>
                            </div>
                        </fieldset>
                    </div>
                    <button type="submit">üöÄ Predict & Explain Satisfaction</button>
                </form>
            </section>
            
            <section id="results-section" class="results-section" style="display: none;">
                <h2>Prediction Results</h2>
                <div class="prediction-metrics">
                    <div class="metric-card">
                        <h3>Predicted Satisfaction Level</h3>
                        <p id="predictedSatisfaction" class="big-text"></p>
                    </div>
                    <div class="metric-card">
                        <h3>Prediction Confidence</h3>
                        <p id="predictionConfidence" class="big-text"></p>
                    </div>
                </div>
                <div class="tabs">
                    <button class="tab-button active" onclick="openTab(event, 'aiSummary')">‚ú® AI Summary</button>
                    <button class="tab-button" onclick="openTab(event, 'detailedAnalysis')">üß† Detailed Analysis</button>
                    <button class="tab-button" onclick="openTab(event, 'modelInput')">‚öôÔ∏è Model Input</button>
                </div>
                <div id="aiSummary" class="tab-content active">
                    <h3>üìù Generative AI Explanation</h3>
                    <div id="genaiExplanation" class="explanation-content"></div>
                </div>
                <div id="detailedAnalysis" class="tab-content">
                    <h3>üéØ Top Contributing Factors (SHAP)</h3>
                    <ul id="topFeaturesList" class="features-list"></ul>
                    <h3>üìà SHAP Waterfall Plot</h3>
                    <div id="shapWaterfallPlot" class="chart-container">
                        <p>A SHAP waterfall plot would appear here. The bar chart below shows the impact of each feature.</p>
                        <canvas id="shapBarChart"></canvas>
                    </div>
                </div>
                <div id="modelInput" class="tab-content">
                    <h3>üî¢ Features Sent to Model</h3>
                    <pre><code id="modelInputJson"></code></pre>
                </div>
            </section>
        </main>
    </div>

    <div class="social-media-icons">
        <a href="https://ahfid.org/contact-us/#" target="_blank" title="Website"><i class="fas fa-globe"></i></a>
        <a href="https://wa.me/2348034011043" target="_blank" title="WhatsApp"><i class="fab fa-whatsapp"></i></a>
        <a href="https://x.com/Ahfidorg" target="_blank" title="X (Twitter)"><i class="fab fa-xing"></i></a>
        <a href="https://instagram.com/Ahfidorg" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
        <a href="https://youtube.com/@AfricaHubforInnovation" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
        <a href="https://web.facebook.com/profile.php?id=61578622870670" target="_blank" title="Facebook"><i class="fab fa-facebook"></i></a>
    </div>

    <img src="/static/images/ahfid.png" alt="AHFID Logo" class="ahfid-logo-bottom">

    <footer>
        <p>&copy; 2025 Gamsuwa - Africa Hub for Innovation and Development. All rights reserved.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- Dark Mode Toggle Logic ---
            const darkModeToggle = document.getElementById('darkModeToggle');
            const body = document.body;

            if (localStorage.getItem('darkMode') === 'enabled') {
                body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }

            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    body.classList.add('dark-mode');
                    localStorage.setItem('darkMode', 'enabled');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('darkMode', 'disabled');
                }
                if (window.lastShapData) {
                    renderShapBarChart(window.lastShapData.featureNames, window.lastShapData.shapValues);
                }
            });

            // --- Original JS for categories and form submission ---
            async function loadCategories() {
                try {
                    const response = await fetch('/api/categories');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const categories = await response.json();

                    const employmentSelect = document.getElementById('employment');
                    employmentSelect.innerHTML = '';
                    categories.Employment_Grouped.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        employmentSelect.appendChild(option);
                    });

                    const educationSelect = document.getElementById('education');
                    educationSelect.innerHTML = '';
                    categories.Education_Grouped.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        educationSelect.appendChild(option);
                    });

                    const stateSelect = document.getElementById('state');
                    if (categories.State && categories.State.length > 0) {
                        stateSelect.innerHTML = '<option value="">Select State (Optional)</option>';
                        categories.State.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat;
                            option.textContent = cat;
                            stateSelect.appendChild(option);
                        });
                    } else {
                        stateSelect.parentElement.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading categories:', error);
                    alert('Failed to load category options. Please try again later.');
                }
            }

            loadCategories();

            const form = document.getElementById('predictionForm');
            form.addEventListener('submit', async function (event) {
                event.preventDefault();
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                
                // The API now expects these scores as Likert scale strings, so no conversion is needed on the client side.
                // The conversion from string to float is now handled by the Python API.
                
                if (!data['State']) delete data['State'];

                const submitButton = document.querySelector('button[type="submit"]');
                submitButton.textContent = 'Analyzing...';
                submitButton.disabled = true;
                document.getElementById('results-section').style.display = 'none';

                try {
                    const response = await fetch('/api/predict_explain', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    document.getElementById('predictedSatisfaction').textContent = result.prediction;
                    document.getElementById('predictionConfidence').textContent = result.confidence;
                    document.getElementById('genaiExplanation').innerHTML = marked.parse(result.genai_explanation);

                    const topFeaturesList = document.getElementById('topFeaturesList');
                    topFeaturesList.innerHTML = '';
                    for (const feature in result.top_features) {
                        const value = result.top_features[feature];
                        const impact = value > 0 ? 'Positive' : 'Negative';
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${feature.replace(/_/g, ' ')}</strong>: SHAP Value = <code>${value.toFixed(3)}</code> (<span class="${impact.toLowerCase()}">${impact}</span> impact)`;
                        topFeaturesList.appendChild(li);
                    }

                    document.getElementById('modelInputJson').textContent = JSON.stringify(result.feature_values.reduce((obj, val, i) => {
                        obj[result.feature_names[i]] = val;
                        return obj;
                    }, {}), null, 2);

                    window.lastShapData = { featureNames: result.feature_names, shapValues: result.shap_values };
                    renderShapBarChart(result.feature_names, result.shap_values);
                    document.getElementById('results-section').style.display = 'block';
                    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

                } catch (error) {
                    console.error('Error during prediction:', error);
                    alert(`Prediction failed: ${error.message}`);
                } finally {
                    submitButton.textContent = 'üöÄ Predict & Explain Satisfaction';
                    submitButton.disabled = false;
                }
            });

            window.openTab = function (evt, tabName) {
                var i, tabcontent, tablinks;
                tabcontent = document.getElementsByClassName("tab-content");
                for (i = 0; i < tabcontent.length; i++) {
                    tabcontent[i].style.display = "none";
                }
                tablinks = document.getElementsByClassName("tab-button");
                for (i = 0; i < tablinks.length; i++) {
                    tablinks[i].className = tablinks[i].className.replace(" active", "");
                }
                document.getElementById(tabName).style.display = "block";
                evt.currentTarget.className += " active";
            }

            document.querySelector('.tab-button').click();

            function renderShapBarChart(featureNames, shapValues) {
                const ctx = document.getElementById('shapBarChart').getContext('2d');
                const isDarkMode = document.body.classList.contains('dark-mode');

                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#E0E0E0' : '#333';
                const positiveColor = '#4CAF50';
                const negativeColor = '#F44336';
                const positiveBorder = '#388E3C';
                const negativeBorder = '#D32F2F';

                const combined = featureNames.map((name, i) => ({ name, value: shapValues[i] }));
                combined.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));

                const sortedFeatureNames = combined.map(item => item.name.replace(/_/g, ' '));
                const sortedShapValues = combined.map(item => item.value);

                if (window.shapChart) window.shapChart.destroy();

                window.shapChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedFeatureNames,
                        datasets: [{
                            label: 'SHAP Value',
                            data: sortedShapValues,
                            backgroundColor: sortedShapValues.map(value => value > 0 ? positiveColor : negativeColor),
                            borderColor: sortedShapValues.map(value => value > 0 ? positiveBorder : negativeBorder),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: gridColor },
                                ticks: { color: textColor },
                                title: { display: true, text: 'SHAP Value (Impact on Prediction)', color: textColor }
                            },
                            y: {
                                grid: { color: gridColor },
                                ticks: { color: textColor },
                                title: { display: true, text: 'Feature', color: textColor }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { 
                                display: true, 
                                text: 'Feature Importance (SHAP Values)',
                                color: textColor,
                                font: { size: 16 }
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html> -->